---
title: "Phenotype Analysis of Brazilian Drought Trials"
author: 
  - Costa, W. G.^[Weverton Gomes da Costa, Pós-Doutorando, Embrapa Mandioca e Fruticultura, wevertonufv@gmail.com]
date: "`r Sys.Date()`"
site: workflowr::wflow_site
output:
  workflowr::wflow_html:
    toc: FALSE
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE)
```

## Libraries

Load Libraries

```{r  message=FALSE}
library(kableExtra)
library(tidyverse)
#if (!require("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
#BiocManager::install("ComplexHeatmap")
require(ComplexHeatmap)
library(data.table)
library(readxl)
library(metan)
library(DataExplorer)
library(ggthemes)
library(GGally)
theme_set(theme_bw())
```

## Data import and manipulation

Let's import the phenotypic dataset, excluding the traits without information and the traits Local (redundant with Year) and Treatment (only one observation).

```{r}
pheno <- read_excel("data/Phenotyping2.xlsx", na = "NA") %>%
  select_if(~ !all(is.na(.))) %>%  # Deleting traits without information
  select(-c("Local", "Tratamento"))
```

We will perform some manipulations to adjust our database and to facilitate the visualization of the exploratory analysis.

First, let's convert the traits that are character into factors. Then we will convert the traits that refer to the grades to integers and then into factors. After that, let's create the trait ANo.Bloco for nesting in the model to obtain the BLUPs.

```{r}
pheno <- pheno %>%
  mutate(
    Clone = as.factor(Clone),
    Ano = as.factor(Ano),
    Bloco = as.factor(Bloco),
    row = as.factor(row),
    col = as.factor(col)
  )   # Convert Clone, Ano, row, col and Bloco in factors
```

## Exploratory Data Analysis

Introductory analysis of the entire dataset

```{r}
introduce(pheno) %>%
  t() %>%
  kbl(escape = F, align = 'c') %>%
  kable_classic(
    "hover",
    full_width = F,
    position = "center",
    fixed_thead = T
  )
```

We don't have any columns that have all of the missing observations, but we do have a lot of missing values in every dataset. Some manipulations should be performed to improve the quality of the data.

### Year Analysis

Let's produce a heatmap to check the clone amount each year. I'm going to create another dataset with the Year and Clone count. Then I will create the objects corresponding to the clones and years array. Finally, I created the matrix that represents the presence and absence of the clone in the year.

```{r}
pheno2 <- pheno %>%
  count(Ano, Clone)

genmat <- model.matrix( ~ -1 + Clone, data = pheno2)
envmat <- model.matrix( ~ -1 + Ano, data = pheno2)
genenvmat <- t(envmat) %*% genmat
genenvmat_ch <- ifelse(genenvmat == 1, "Present", "Abscent")

Heatmap(
  genenvmat_ch,
  col = c("white", "tomato"),
  show_column_names = F,
  heatmap_legend_param = list(title = ""),
  column_title = "Genotypes",
  row_title = "Environments"
)
```

From the heatmap, it is clear that the year 2016 has very few observations. So, we must eliminate it.

```{r}
pheno <- pheno %>%
  filter(Ano != 2016) %>%
  droplevels()
```

Just for reference, let's re-view the clone heatmap by year.

```{r}
pheno2 <- pheno %>%
  count(Ano, Clone)

genmat = model.matrix(~ -1 + Clone, data = pheno2)
envmat = model.matrix(~ -1 + Ano, data = pheno2)
genenvmat = t(envmat) %*% genmat
genenvmat_ch = ifelse(genenvmat == 1, "Present", "Abscent")

Heatmap(
  genenvmat_ch,
  col = c("white", "tomato"),
  show_column_names = F,
  heatmap_legend_param = list(title = ""),
  column_title = "Genotypes",
  row_title = "Environments"
)
```

We can check how many clones we have in common between the years and also note that the years differ in the number of clones evaluated:

############# Table 1 - Year of evaluation and number of genotypes evaluated

```{r}
pheno2 <- pheno %>%
  count(Ano, Clone)

genmat = model.matrix(~ -1 + Clone, data = pheno2)
envmat = model.matrix(~ -1 + Ano, data = pheno2)
genenvmat = t(envmat) %*% genmat

genenvmat %*% t(genenvmat) %>%
  kbl(escape = F, align = 'c') %>%
  kable_classic(
    "hover",
    full_width = F,
    position = "center",
    fixed_thead = T
  )

rm(pheno2, genmat, envmat, genenvmat, genenvmat_ch)
```

The year 2020 has a lower number of clones in common, however, we will keep it for the analysis.

Here, it is possible to observe that our dataset has clones that were evaluated in just one year. Let's visualize this, to see how many clones were evaluated according to the number of years.

```{r}
pheno %>%
  count(Ano, Clone) %>%
  count(Clone) %>%
  count(n) %>%
  kbl(
    escape = F,
    align = 'c',
    col.names = c("N of Environment", "N of genotypes")
  ) %>%
  kable_classic(
    "hover",
    full_width = F,
    position = "center",
    fixed_thead = T
  )
```

Only 5 clones were evaluated in all years, this will possibly decrease our model accuracy.

Another factor that reduces the accuracy, and therefore adopting mixed models via REML in the analysis is the most suitable for obtaining BLUPs.

### Analysis of traits

Inicialmente, iremos verificar as estatísticas descritivas para cada coluna.

```{r}
summary(pheno) %>%
  t() %>%
  kbl(escape = F, align = 'c') %>%
  kable_classic(
    "hover",
    full_width = F,
    position = "center",
    fixed_thead = T
  )
```

We have a high missing value ratio for Vigor, Leaf_Lenght, Canopy_Width and Canopy_Lenght, I'll exclude those too. Mite Incidence and Flowering  have little information for some levels and many NA's, we will also exclude these traits.

```{r}
pheno <- pheno %>%
  select(-c(
    Incidence_Mites,
    Vigor,
    Flowering,
    Leaf_Lenght,
    Canopy_Width,
    Canopy_Lenght
  ))
```

Let's just look at the missing values now, to check the proportions.

```{r}
plot_missing(pheno)
```

StC, DMC and StY still do not have good quality, but we will maintain these traits, as they are important to us.

Let's check the distribution of traits by year now and let's look at the histograms of the quantitative traits:

```{r}
plot_histogram(pheno, ncol = 6)
```

For Branching, Leaf.Ret, Mite, PltArc, Stand6MAP and Staygreen don't have normal distribution. To get the BLUPs we will have to remove that traits from the database.

```{r}
pheno <- pheno %>%
  select(-c(Branching, Leaf.Ret, Mite, PltArc, Stand6MAP, Staygreen))
```

### Analisys of Clone

First, let's check the amount of missing values for each clone by year. We are filtering the Clones with the average bigger than 2 missing values by year. 

```{r}
pheno2 <- pheno %>%
  select(-Bloco) %>%
  group_by(Clone, Ano) %>%
  summarise_all(.funs = list(~ sum(is.na(.)))) %>%
  ungroup() %>%
  select_numeric_cols() %>%
  mutate(mean = rowMeans(.), Clone.Ano = unique(interaction(pheno$Clone, pheno$Ano))) %>%
  filter(mean > 2) %>%
  droplevels()

nlevels(pheno2$Clone.Ano) %>%
  kbl(
    escape = F,
    align = 'c',
    col.names = c("N of genotypes")
  ) %>%
  kable_classic(
    "hover",
    full_width = F,
    position = "center",
    fixed_thead = T
  )

rm(pheno2)
```

76 clones presented many missing values, i.e., they were evaluated in less than two blocks by year. Therefore, they should be excluded from future analyses, according to the year.

Let's evaluate the descriptive statistics of the combination between clone and year for the traits.

```{r}
ge_details(pheno, Ano, Clone, resp = everything()) %>%
  t() %>%
  kbl(escape = F, align = 'c') %>%
  kable_classic(
    "hover",
    full_width = F,
    position = "center",
    fixed_thead = T
  )
```

Apparently we no longer have a genotype that could harm our analysis. Now we must evaluate the clone-only descriptive statistics for the traits.
Some traits presented hight cv, StY and FRY, but we will go continue.

```{r}
desc_stat(pheno,
          by = Ano,
          na.rm = TRUE,
          stats = "cv") %>%
  na.omit() %>%
  arrange(desc(cv)) %>%
  pivot_wider(names_from = "Ano", values_from = "cv") %>%
  kbl(escape = F, align = 'c') %>%
  kable_classic(
    "hover",
    full_width = F,
    position = "center",
    fixed_thead = T
  )
```

Again, some traits were not computed for the year 2017, so we have to eliminate that year when performing the analysis for these traits.

What draws attention in this table are the high cv for some traits, especially: HI, Nstem.Plant, N_Roots, ShY, StY and FRY.

This may be due to the presence of outliers, let's inspect the entire dataset to assess whether there are outliers:

```{r}
inspect(pheno %>%
          select_if(~ !is.factor(.)), verbose = FALSE) %>%
  arrange(desc(Outlier)) %>%
  kbl(escape = F, align = 'c') %>%
  kable_classic(
    "hover",
    full_width = F,
    position = "center",
    fixed_thead = T
  )
```

Confirming what was described before, most traits with high cv have many outliers and therefore we will exclude them in the loop to obtain the blups.

#### General Inspection

Now let's just perform a general inspection of the data to finish the manipulations.

```{r}
corr_plot(pheno, col.by = Ano)
```

StC with DMC and StY with FRY show high correlation.

Furthermore most of the traits apparently show normal distribution of phenotypic data. So let's save the clean data and move on to getting the blups.

```{r}
write.csv(pheno,
          "data/pheno_clean.csv",
          row.names = F,
          quote = F)

pheno_mean_sd <- desc_stat(pheno, stats = c("mean, min, max, cv"))

write.csv(pheno_mean_sd,
          "output/pheno_mean_sd.csv",
          row.names = F,
          quote = F)
```

Proceed with Genotype-environment analysis using mixed-effect models to obtain BLUPs (Best Linear Unbiased Predictors) and further interpret the results to identify superior genotypes.
